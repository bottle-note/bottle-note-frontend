name: Version Tag Sync

on:
  push:
    branches: [main]
    paths:
      - 'VERSION'

concurrency:
  group: version-tag-sync
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  create-tag:
    runs-on: ubuntu-latest

    steps:
      - name: checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: check version file changed
        id: version-change
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -q "^VERSION$"; then
            VERSION=$(cat VERSION | tr -d '[:space:]')
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "frontend VERSION changed: $VERSION"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "VERSION not changed, skipping"
          fi

      - name: create and push tag
        if: steps.version-change.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          VERSION="${{ steps.version-change.outputs.version }}"
          TAG_NAME="frontend/v${VERSION}"

          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists, skipping"
          else
            git tag -a "$TAG_NAME" -m "Release frontend v${VERSION}"
            git push origin "$TAG_NAME"
            echo "Created and pushed tag: $TAG_NAME"
          fi

  create-release-pr:
    runs-on: ubuntu-latest

    steps:
      - name: checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: check version file changed
        id: version-change
        run: |
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.event.after }}"

          if git diff --name-only "$BEFORE" "$AFTER" | grep -q "^VERSION$"; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            VERSION=$(cat VERSION | tr -d '[:space:]')
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "frontend VERSION changed: $VERSION"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "VERSION not changed, skipping"
          fi

      - name: check existing pr
        if: steps.version-change.outputs.changed == 'true'
        id: existing-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_DATA=$(gh pr list \
            --base "release" \
            --head "main" \
            --state open \
            --json number,title \
            --limit 1)

          if [ "$PR_DATA" != "[]" ]; then
            PR_NUMBER=$(echo "$PR_DATA" | jq -r '.[0].number')
            PR_TITLE=$(echo "$PR_DATA" | jq -r '.[0].title')
            {
              echo "exists=true"
              echo "pr_number=$PR_NUMBER"
              echo "pr_title=$PR_TITLE"
            } >> "$GITHUB_OUTPUT"
            echo "Existing PR found: #$PR_NUMBER - $PR_TITLE"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "No existing PR found"
          fi

      - name: extract version from existing pr title
        if: steps.version-change.outputs.changed == 'true' && steps.existing-pr.outputs.exists == 'true'
        id: existing-version
        run: |
          PR_TITLE="${{ steps.existing-pr.outputs.pr_title }}"
          EXISTING_VERSION=$(echo "$PR_TITLE" | grep -oP 'v\K[0-9]+\.[0-9]+\.[0-9]+(-[0-9]+)?' || echo "0.0.0")
          echo "version=$EXISTING_VERSION" >> "$GITHUB_OUTPUT"
          echo "Existing PR version: $EXISTING_VERSION"

      - name: compare versions
        if: steps.version-change.outputs.changed == 'true' && steps.existing-pr.outputs.exists == 'true'
        id: compare
        run: |
          NEW_VERSION="${{ steps.version-change.outputs.version }}"
          OLD_VERSION="${{ steps.existing-version.outputs.version }}"

          version_to_int() {
            echo "$1" | awk -F'[-.]' '{ printf("%d%03d%03d%03d", $1, $2, $3, (NF>=4 ? $4 : 0)) }'
          }

          NEW_INT=$(version_to_int "$NEW_VERSION")
          OLD_INT=$(version_to_int "$OLD_VERSION")

          if [ "$NEW_INT" -lt "$OLD_INT" ]; then
            echo "ERROR: New version ($NEW_VERSION) is lower than existing PR version ($OLD_VERSION)"
            exit 1
          elif [ "$NEW_INT" -gt "$OLD_INT" ]; then
            echo "result=update" >> "$GITHUB_OUTPUT"
            echo "New version is higher, will update PR"
          else
            echo "result=skip" >> "$GITHUB_OUTPUT"
            echo "Same version, skipping"
          fi

      - name: ensure release branch exists
        if: steps.version-change.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if ! git ls-remote --heads origin "release" | grep -q "release"; then
            echo "Creating release branch"
            git push origin "HEAD:refs/heads/release"
          else
            echo "Release branch exists"
          fi

      - name: create pr
        if: steps.version-change.outputs.changed == 'true' && steps.existing-pr.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version-change.outputs.version }}"
          DATE=$(date +'%Y.%m.%d')

          TITLE="[deploy] frontend-v${VERSION}"
          BODY=$(cat <<EOF
          ## Release frontend v${VERSION}

          - **Version**: ${VERSION}
          - **Created at**: ${DATE}
          - **Auto-generated release PR**

          ---
          This PR was automatically created by version-tag-sync workflow.
          EOF
          )

          gh pr create \
            --base "release" \
            --head "main" \
            --title "$TITLE" \
            --body "$BODY"

          echo "PR created: $TITLE"

      - name: update pr
        if: steps.version-change.outputs.changed == 'true' && steps.existing-pr.outputs.exists == 'true' && steps.compare.outputs.result == 'update'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version-change.outputs.version }}"
          PR_NUMBER="${{ steps.existing-pr.outputs.pr_number }}"
          DATE=$(date +'%Y.%m.%d')

          TITLE="[deploy] frontend-v${VERSION}"
          BODY=$(cat <<EOF
          ## Release frontend v${VERSION}

          - **Version**: ${VERSION}
          - **Updated at**: ${DATE}
          - **Auto-generated release PR**

          ---
          This PR was automatically created by version-tag-sync workflow.
          EOF
          )

          gh pr edit "$PR_NUMBER" \
            --title "$TITLE" \
            --body "$BODY"

          echo "PR #$PR_NUMBER updated: $TITLE"
