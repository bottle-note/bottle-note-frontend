name: Deploy Development

on:
  workflow_dispatch:
  push:
    branches: [main]

concurrency:
  group: deploy-development
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build-and-push:
    runs-on: ubuntu-24.04-arm

    outputs:
      image-tag: ${{ steps.image-tag.outputs.tag }}
      short-sha: ${{ steps.image-tag.outputs.short-sha }}

    steps:
      - name: checkout code
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.GIT_ACCESS_TOKEN }}

      - name: generate image tag
        id: image-tag
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          echo "short-sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "tag=dashboard_dev_${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: build and push docker image
        uses: ./.github/actions/docker-build-push
        with:
          registry-url: ${{ secrets.REGISTRY_ADDRESS }}
          registry-username: ${{ secrets.REGISTRY_USERNAME }}
          registry-password: ${{ secrets.REGISTRY_PASSWORD }}
          image-name: bottlenote-admin-dashboard
          image-tag: ${{ steps.image-tag.outputs.tag }}
          additional-tags: dashboard_dev_latest
          cache-scope: dashboard-development
          sops-age-key: ${{ secrets.SOPS_AGE_SECRET_KEY }}
          env-file: git.environment-variables/application.next-js/dev.sops.env
          sign-image: 'true'
          cosign-key-path: git.environment-variables/storage/docker-registry/cosign.key
          cosign-password: ${{ secrets.COSIGN_PASSWORD }}

  update-development:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: checkout code
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.GIT_ACCESS_TOKEN }}

      - name: setup kustomize
        uses: imranismail/setup-kustomize@v2

      - name: update kustomize image tag
        env:
          REGISTRY: ${{ secrets.REGISTRY_ADDRESS }}
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image-tag }}
        run: |
          cd git.environment-variables
          git checkout main

          cd deploy/overlays/development
          kustomize edit set image \
            bottlenote-admin-dashboard=${REGISTRY}/bottlenote-admin-dashboard:${IMAGE_TAG}

      - name: commit and push
        env:
          SHORT_SHA: ${{ needs.build-and-push.outputs.short-sha }}
        run: |
          cd git.environment-variables
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add deploy/overlays/development/kustomization.yaml

          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "chore(dev): update dashboard development image tag (${SHORT_SHA})

          Dashboard: dashboard_dev_${SHORT_SHA}

          Updated by GitHub Actions
          Commit: ${{ github.sha }}
          Workflow: ${{ github.workflow }}"

          for i in {1..5}; do
            git pull --rebase origin main && git push origin main && break
            sleep $((i * 2))
          done
